---
- name: Configure Tendermint Cluster
  hosts: tendermint-cluster
  become: yes

  vars:
    config_folder: examples/in-proc-linux
    remote_base_path: /root
    remote_tendermint_path: "{{ remote_base_path }}/.tendermint"
    tendermint_net_name: mytestnet
    gopath: "{{ lookup('env','GOPATH') }}"
    s3_binary: https://s3-us-west-2.amazonaws.com/tendermint/0.8.0/tendermint_linux_amd64.zip
    s3_binary_sha256: 83f6bd52055ebc93434a68263c6666a4de41e0e543d0b5a06ad461262c460f4c
    binary_zip_name: tendermint_linux_amd64.zip
    # Uncomment this line if you want to upload locally compiled binary
    # local_binary = true

  tasks:
  - name: Create tendermint folder on remote host
    file: path="{{ remote_tendermint_path }}" state=directory

# TODO: Adapt the following step for any number of mach folders
  - name: Copy priv_validator.json
    copy:
      src: "{{ tendermint_net_name }}/{{ mach_folder }}/priv_validator.json"
      dest: "{{ remote_tendermint_path }}/priv_validator.json"
    notify: restart tendermint service

  - name: Copy genesis.json from mach0
    copy:
      src: "{{ tendermint_net_name }}/mach0/genesis.json"
      dest: "{{ remote_tendermint_path }}/genesis.json"
    notify: restart tendermint service

  - name: Copy run.sh
    copy:
      src: "{{ config_folder }}/run.sh"
      dest: "{{ remote_base_path }}/run.sh"
      mode: "0777"
    notify: restart tendermint service

  - name: Copy binary file from localhost if local_binary variable is set
    copy:
      src: "{{ gopath }}/bin/tendermint"
      dest: "{{ remote_base_path }}"
      mode: "u+rx,g+r,o+r"
    when: local_binary is defined and local_binary
    notify: restart tendermint service

  - name: Get binary file from S3
    get_url:
      url: "{{ s3_binary }}"
      dest: "/tmp"
      mode: "u+rx,g+r,o+r"
      checksum: "sha256:{{ s3_binary_sha256 }}"
    when: local_binary is not defined
    notify: restart tendermint service

  - name: Install unzip to deal with an archived binary
    apt:
      name: unzip
      update_cache: yes

  - name: Unarchive downloaded from S3 zip file
    unarchive:
      src: "/tmp/{{ binary_zip_name }}"
      dest: "{{ remote_base_path }}"
      creates: "{{ remote_base_path }}/tendermint"
      remote_src: True
    when: local_binary is not defined
    notify: restart tendermint service

  # - name: Run shell command to start application
  #   shell:  "nohup {{ remote_base_path }}/tendermint node --proxy_app=dummy --log_level=note $SEEDS_FLAG >> tendermint.log 2>&1 &"
  #   tags: shell

  handlers:
  - name: restart tendermint service
    shell:  "nohup {{ remote_base_path }}/tendermint node --proxy_app=dummy --log_level=note $SEEDS_FLAG >> tendermint.log 2>&1 &"
